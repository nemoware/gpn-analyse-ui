<ngx-spinner bdColor="rgba(250,250,250,0.2)" size="large" color="#0074D9" type="timer">
  <p style="font-size: 30px; color: #0074D9">Загрузка...</p>
</ngx-spinner>
<table mat-table [dataSource]="dataSource" matSort  multiTemplateDataRows matSortActive="document" matSortDirection="desc" (mouseleave) = "mouseOverIndex=-1">


  <ng-container *ngIf="!conclusion" matColumnDef="select">
    <th mat-header-cell *matHeaderCellDef>
      <mat-checkbox (change)="$event ? masterToggle() : null"
                    [checked]="selection.hasValue() && isAllSelected()"
                    [indeterminate]="selection.hasValue() && !isAllSelected()"
      >
      </mat-checkbox>
    </th>
    <td mat-cell *matCellDef="let row">
      <ng-container *ngIf="!row.userViolation">
        <mat-checkbox (click)="$event.stopPropagation()"
                      (change)="$event ? toggleSelection(row) : null"
                      [checked]="selection.isSelected(row)"
        >
        </mat-checkbox>
      </ng-container>
    </td>
  </ng-container>

  <!-- Создатель -->
  <ng-container matColumnDef="creator">
    <th mat-header-cell *matHeaderCellDef >Создатель</th>
    <td mat-cell *matCellDef="let row">
      <div *ngIf="row.userViolation">
        <mat-icon>person</mat-icon>
      </div>
      <div *ngIf="!row.userViolation">
        <mat-icon>computer</mat-icon>
      </div>
    </td>
  </ng-container>

  <!-- Документ -->
  <ng-container matColumnDef="document">
    <th mat-header-cell *matHeaderCellDef >Документ, имеющий нарушение</th>
    <td mat-cell *matCellDef="let row">
      <span class="doc_type reference" (click)="openDocument(row.document.id)">{{ row.document.type | translate }}</span>
      <span class="number"> № {{ row.document.number  }}</span>
    </td>
  </ng-container>

  <!-- Учредительный док. -->
  <ng-container matColumnDef="founding_document">
    <th mat-header-cell *matHeaderCellDef >Учредительный документ</th>
    <td mat-cell *matCellDef="let row">
      <div *ngIf="row.founding_document">
        <span class="doc_type">Устав в редакции от {{ row.founding_document.date | date}}</span>
      </div>
    </td>
  </ng-container>

  <!-- Пункт -->
  <ng-container matColumnDef="reference">
    <th mat-header-cell *matHeaderCellDef >Подпункт, пункт, статья</th>
    <td mat-cell *matCellDef="let row">
      <span class="reference" *ngIf="row.reference && row.reference.text" (click)="openDocument(row.reference.id, row.reference.attribute)">
        {{ row.reference.text  }}
      </span>
      <div *ngIf="row.userViolation">
        <span class="reference" *ngIf="row.reference" (click)="openDocument(row.founding_document.id)">{{row.reference}}</span>
      </div>
    </td>
  </ng-container>

  <!-- Нарушение -->
  <ng-container matColumnDef="violation_type">
    <th mat-header-cell *matHeaderCellDef >Нарушение</th>
    <td mat-cell *matCellDef="let row">
      <div *ngIf="row.violation_type">
        <span> <b> {{ getViolation(row) }}</b> </span>
        <div *ngIf="row.violation_type.type">
          Отсутствует одобрение <span>{{row.violation_type.org_structural_level | translate}}</span> на совершение
          <span>{{row.violation_type.subject | translate}} </span>
          <span *ngIf="row.violation_type.min || row.violation_type.max"> на сумму,
            <span *ngIf="row.violation_type.min"> превыщающих {{row.violation_type.min.value | currency : row.violation_type.min.currency}} </span>
            <span *ngIf="row.violation_type.min && row.violation_type.max"> и </span>
            <span *ngIf="row.violation_type.max"> не превыщающих {{row.violation_type.max.value | currency : row.violation_type.max.currency}} </span>
          </span>
        </div>
        <div *ngIf="row.userViolation">
          <span>{{row.violation_text}}</span>
        </div>
      </div>

      <div *ngIf="row.document.warnings && !conclusion">
        <span class='warning'><b>В результате выполненного анализа в документах были определены не все атрибуты</b></span>
        <li *ngFor="let w of row.document.warnings"> {{w.code | translate}}</li>
      </div>
    </td>
  </ng-container>

  <!-- Основание -->
  <ng-container matColumnDef="violation_reason">
    <th mat-header-cell *matHeaderCellDef >Основание нарушения</th>
    <td mat-cell *matCellDef="let row">

      <div *ngIf="row.violation_reason">
        <div *ngIf="row.violation_reason.contract">
          <b>Договор</b> № <span>{{row.violation_reason.contract.number}}</span> от <span>{{row.violation_reason.contract.date | date}}</span> c
          <span>{{row.violation_reason.contract.org_type}} {{row.violation_reason.contract.org_name}}</span>
          <span *ngIf="row.violation_reason.contract.value">, цена сделки - {{row.violation_reason.contract.value | currency : row.violation_reason.contract.currency}}</span>
        </div>
        <div *ngIf="row.violation_reason.protocol">
          <b>Протокол</b> <span> {{row.violation_reason.protocol.org_structural_level | translate}}</span> от <span>{{row.violation_reason.protocol.date | date}}</span>
          <span *ngIf="row.violation_reason.protocol.value">, сумма - {{row.violation_reason.protocol.value | currency : row.violation_reason.protocol.currency}}</span>
        </div>
        <div *ngIf="row.violation_reason.charters">
          <span *ngFor="let item of row.violation_reason.charters"> <b>Устав</b> от {{ item.date | date }}</span>
        </div>
      </div>

      <div *ngIf="row.userViolation">
        <span>{{row.violation_reason_text}}</span>
      </div>
    </td>
  </ng-container>

  <ng-container matColumnDef="events">
    <th mat-header-cell *matHeaderCellDef> </th>
    <td mat-cell *matCellDef="let row; let index = index;">
      <div class="btn-group" *ngIf="row.userViolation">
        <fa-icon id="td_events" [icon]="faTrashAlt" matTooltip="Удалить" style="float: right" (click)="deleteViolation(row, $event)"></fa-icon>
      </div>
    </td>
  </ng-container>


  <tr mat-header-row *matHeaderRowDef="col"></tr>
  <tr mat-row *matRowDef="let row; columns: col; let index = dataIndex;" class="element-row" (click)="editViolation(row, index)" (mouseover)="onMouseOver(index)" ></tr>
</table>
